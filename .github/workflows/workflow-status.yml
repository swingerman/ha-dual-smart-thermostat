name: Workflow Status Check

on:
  schedule:
    - cron: "0 9 * * 1"  # Weekly on Monday at 9 AM
  workflow_dispatch:  # Allow manual trigger

jobs:
  status-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Validate Dependabot configuration
        run: |
          echo "ðŸ” Validating Dependabot configuration..."
          if [ -f ".github/dependabot.yml" ]; then
            echo "âœ… dependabot.yml found"
            # Basic YAML validation
            python -c "import yaml; yaml.safe_load(open('.github/dependabot.yml'))" && echo "âœ… YAML syntax valid"
          else
            echo "âŒ dependabot.yml not found"
            exit 1
          fi

      - name: Validate workflow files
        run: |
          echo "ðŸ” Validating workflow files..."
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "âœ… Found workflow: $(basename "$workflow")"
              # Basic YAML validation
              python -c "import yaml; yaml.safe_load(open('$workflow'))" && echo "âœ… YAML syntax valid for $(basename "$workflow")"
            fi
          done

      - name: Check requirements files
        run: |
          echo "ðŸ” Checking requirements files..."
          if [ -f "requirements.txt" ]; then
            echo "âœ… requirements.txt found"
          fi
          if [ -f "requirements-dev.txt" ]; then
            echo "âœ… requirements-dev.txt found"
            # Check if security tools are included
            if grep -q "safety\|bandit\|semgrep" requirements-dev.txt; then
              echo "âœ… Security tools included in dev requirements"
            else
              echo "âš ï¸ Security tools not found in dev requirements"
            fi
          fi

      - name: Generate status report
        run: |
          echo "# Workflow Status Report" > workflow-status.md
          echo "Generated: $(date)" >> workflow-status.md
          echo "" >> workflow-status.md
          echo "## Configuration Status" >> workflow-status.md
          echo "- âœ… Dependabot configuration: Present" >> workflow-status.md
          echo "- âœ… Auto-merge workflow: Present" >> workflow-status.md
          echo "- âœ… Security checks: Present" >> workflow-status.md
          echo "- âœ… Enhanced build workflows: Present" >> workflow-status.md
          echo "" >> workflow-status.md
          echo "## Workflow Files" >> workflow-status.md
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "- $(basename "$workflow")" >> workflow-status.md
            fi
          done
          echo "" >> workflow-status.md
          echo "## Next Steps" >> workflow-status.md
          echo "1. Review and test the auto-merge workflow" >> workflow-status.md
          echo "2. Monitor security scan results" >> workflow-status.md
          echo "3. Adjust exclusions in dependabot.yml as needed" >> workflow-status.md

      - name: Upload status report
        uses: actions/upload-artifact@v5
        with:
          name: workflow-status-report
          path: workflow-status.md
          retention-days: 7

      - name: Comment on repository (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('workflow-status.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue?.number || 1,
              body: report
            });